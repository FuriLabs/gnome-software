From fa85bfaa6ab226cdd98360063735e83dcd2e5445 Mon Sep 17 00:00:00 2001
From: Matthias Klumpp <matthias@tenstral.net>
Date: Fri, 15 Jan 2016 14:59:03 +0100
Subject: Don't fail updates if fwupd daemon does not exist

This resolves https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=808305
---
 src/plugins/gs-plugin-fwupd.c | 34 +++++++++++++++++++++++++++-------
 1 file changed, 27 insertions(+), 7 deletions(-)

diff --git a/src/plugins/gs-plugin-fwupd.c b/src/plugins/gs-plugin-fwupd.c
index d5e5f66..80cf7a5 100644
--- a/src/plugins/gs-plugin-fwupd.c
+++ b/src/plugins/gs-plugin-fwupd.c
@@ -42,6 +42,7 @@ struct GsPluginPrivate {
 	gchar			*cachedir;
 	gchar			*lvfs_sig_fn;
 	gchar			*lvfs_sig_hash;
+	gchar			*config_fn;
 };

 /**
@@ -93,6 +94,16 @@ gs_plugin_initialize (GsPlugin *plugin)
 	plugin->priv = GS_PLUGIN_GET_PRIVATE (GsPluginPrivate);
 	plugin->priv->to_download = g_ptr_array_new_with_free_func (g_free);
 	plugin->priv->to_ignore = g_ptr_array_new_with_free_func (g_free);
+
+	plugin->priv->config_fn = g_build_filename (SYSCONFDIR, "fwupd.conf", NULL);
+	if (!g_file_test (plugin->priv->config_fn, G_FILE_TEST_EXISTS)) {
+		g_free (plugin->priv->config_fn);
+		plugin->priv->config_fn = g_strdup ("/etc/fwupd.conf");
+	}
+	if (!g_file_test (plugin->priv->config_fn, G_FILE_TEST_EXISTS)) {
+		g_debug ("fwupd configuration not found, disabling plugin.");
+		gs_plugin_set_enabled (plugin, FALSE);
+	}
 }

 /**
@@ -104,6 +115,7 @@ gs_plugin_destroy (GsPlugin *plugin)
 	g_free (plugin->priv->cachedir);
 	g_free (plugin->priv->lvfs_sig_fn);
 	g_free (plugin->priv->lvfs_sig_hash);
+	g_free (plugin->priv->config_fn);
 	g_ptr_array_unref (plugin->priv->to_download);
 	g_ptr_array_unref (plugin->priv->to_ignore);
 	if (plugin->priv->proxy != NULL)
@@ -435,6 +447,13 @@ gs_plugin_add_updates_historical (GsPlugin *plugin,
 				      &error_local);
 	if (val == NULL) {
 		if (g_error_matches (error_local,
+				     G_DBUS_ERROR,
+				     G_DBUS_ERROR_SERVICE_UNKNOWN)) {
+			/* the fwupd service might be unavailable, continue in that case */
+			g_debug ("fwupd: Could not get historical updates, service is unknown.");
+			return TRUE;
+		}
+		if (g_error_matches (error_local,
 				     FWUPD_ERROR,
 				     FWUPD_ERROR_NOTHING_TO_DO))
 			return TRUE;
@@ -497,6 +516,13 @@ gs_plugin_add_updates (GsPlugin *plugin,
 				      &error_local);
 	if (val == NULL) {
 		if (g_error_matches (error_local,
+				     G_DBUS_ERROR,
+				     G_DBUS_ERROR_SERVICE_UNKNOWN)) {
+			/* the fwupd service might be unavailable, continue in that case */
+			g_debug ("fwupd: Could not get updates, service is unknown.");
+			return TRUE;
+		}
+		if (g_error_matches (error_local,
 				     FWUPD_ERROR,
 				     FWUPD_ERROR_NOTHING_TO_DO))
 			return TRUE;
@@ -612,7 +638,6 @@ gs_plugin_fwupd_check_lvfs_metadata (GsPlugin *plugin,
 	g_autofree gchar *basename_data = NULL;
 	g_autofree gchar *cache_fn_data = NULL;
 	g_autofree gchar *checksum = NULL;
-	g_autofree gchar *config_fn = NULL;
 	g_autofree gchar *url_data = NULL;
 	g_autofree gchar *url_sig = NULL;
 	g_autoptr(GKeyFile) config = NULL;
@@ -621,12 +646,7 @@ gs_plugin_fwupd_check_lvfs_metadata (GsPlugin *plugin,

 	/* read config file */
 	config = g_key_file_new ();
-	config_fn = g_build_filename (SYSCONFDIR, "fwupd.conf", NULL);
-	if (!g_file_test (config_fn, G_FILE_TEST_EXISTS)) {
-		g_free (config_fn);
-		config_fn = g_strdup ("/etc/fwupd.conf");
-	}
-	if (!g_key_file_load_from_file (config, config_fn, G_KEY_FILE_NONE, error))
+	if (!g_key_file_load_from_file (config, plugin->priv->config_fn, G_KEY_FILE_NONE, error))
 		return FALSE;

 	/* check cache age */
