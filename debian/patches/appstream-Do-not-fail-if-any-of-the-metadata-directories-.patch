From: Robert Ancell <robert.ancell@canonical.com>
Date: Fri, 20 Mar 2020 17:05:17 +1300
Subject: appstream: Do not fail if any of the metadata directories doesn't
 exist

This resolves issue #967
---
 plugins/core/gs-plugin-appstream.c | 10 ++++++++--
 1 file changed, 8 insertions(+), 2 deletions(-)

diff --git a/plugins/core/gs-plugin-appstream.c b/plugins/core/gs-plugin-appstream.c
index 4d8ba51..a0a1f36 100644
--- a/plugins/core/gs-plugin-appstream.c
+++ b/plugins/core/gs-plugin-appstream.c
@@ -173,12 +173,15 @@ gs_plugin_appstream_load_appdata (GsPlugin *plugin,
 				  GError **error)
 {
 	const gchar *fn;
-	g_autoptr(GDir) dir = g_dir_open (path, 0, error);
+	g_autoptr(GDir) dir = NULL;
 	g_autoptr(GFile) parent = g_file_new_for_path (path);
 	if (!g_file_query_exists (parent, cancellable))
 		return TRUE;
+
+	dir = g_dir_open (path, 0, error);
 	if (dir == NULL)
 		return FALSE;
+
 	while ((fn = g_dir_read_name (dir)) != NULL) {
 		if (g_str_has_suffix (fn, ".appdata.xml") ||
 		    g_str_has_suffix (fn, ".metainfo.xml")) {
@@ -264,12 +267,15 @@ gs_plugin_appstream_load_desktop (GsPlugin *plugin,
 				  GError **error)
 {
 	const gchar *fn;
-	g_autoptr(GDir) dir = g_dir_open (path, 0, error);
+	g_autoptr(GDir) dir = NULL;
 	g_autoptr(GFile) parent = g_file_new_for_path (path);
 	if (!g_file_query_exists (parent, cancellable))
 		return TRUE;
+
+	dir = g_dir_open (path, 0, error);
 	if (dir == NULL)
 		return FALSE;
+
 	while ((fn = g_dir_read_name (dir)) != NULL) {
 		if (g_str_has_suffix (fn, ".desktop")) {
 			g_autofree gchar *filename = g_build_filename (path, fn, NULL);
